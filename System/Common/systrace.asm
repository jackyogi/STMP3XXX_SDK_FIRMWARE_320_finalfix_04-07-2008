;///////////////////////////////////////////////////////////////////////////////
;  Copyright(C) SigmaTel, Inc. 2000-2003
;
;  File        : systrace.asm
;  Description : System Trace Macro
;///////////////////////////////////////////////////////////////////////////////

; Note: Because this file uses the push and pop macros, it must be
;       included in the source file after the sysmacro.asm file.

    page    255,255,0

;///////////////////////////////////////////////////////////////////////////////
;   Macros
;///////////////////////////////////////////////////////////////////////////////

;///////////////////////////////////////////////////////////////////////////////
;   Includes
;///////////////////////////////////////////////////////////////////////////////

    nolist
    include "../../inc/sysequ.inc"
    list

;///////////////////////////////////////////////////////////////////////////////
;   External Definitions
;///////////////////////////////////////////////////////////////////////////////

;///////////////////////////////////////////////////////////////////////////////
;   External References
;///////////////////////////////////////////////////////////////////////////////

    nolist
    include "sysmem.xref"
    list

  if (@def('TRACEBUF_EN'))
;///////////////////////////////////////////////////////////////////////////////
;   Equates
;///////////////////////////////////////////////////////////////////////////////
        
;///////////////////////////////////////////////////////////////////////////////
;   X Memory
;///////////////////////////////////////////////////////////////////////////////
        
;///////////////////////////////////////////////////////////////////////////////
;   Y Memory
;///////////////////////////////////////////////////////////////////////////////
        
;///////////////////////////////////////////////////////////////////////////////
;   P Memory
;///////////////////////////////////////////////////////////////////////////////

;///////////////////////////////////////////////////////////////////////////////
;
;>  Name:           trace
;
;   Type:           Macro
;
;   Description:    Read global x:TracePointer, writes TraceBuffer & incr TracePointer.
;
;   Input:          data = word to write to the trace buffer 
;
;   Outputs:        Updates Trace Buffer and Pointer.
;                   
;   Notes:          Saves and restores registers.
;<
;///////////////////////////////////////////////////////////////////////////////
trace   MACRO   data
        push    r0
        push    m0
        push    a1
        move    #>TRACE_BUFF_MODULO,m0
        move    x:TracePointer,r0
        move    data,a1
        move    a1,x:(r0)+
        move    r0,x:TracePointer
        pop     a1
        pop     m0
        pop     r0
        ENDM

  else   ; TRACEBUF_EN is not defined so trace macro expansion vanishes.
trace   MACRO   data
        ENDM
  endif  ; TRACEBUF_EN

