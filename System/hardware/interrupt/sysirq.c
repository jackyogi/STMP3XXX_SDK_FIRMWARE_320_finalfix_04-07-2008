////////////////////////////////////////////////////////////////////////////////
// Copyright(C) SigmaTel, Inc. 2002
//
// File : sysirq.c
// Description : 
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  Macros
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  Includes
////////////////////////////////////////////////////////////////////////////////

#include "types.h"

////////////////////////////////////////////////////////////////////////////////
//  External Definitions
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  External References
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  Equates
////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////
// Prototypes
///////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  X Memory
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  Y Memory
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//  P Memory
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
//
//>  Name:          SysMaskAllInterrupts
//
//   Type:          Function
//
//   Description:   
//
//   Inputs:        none
//
//   Outputs:       WORD            Old interrupt level bits
//
//   Notes:         none
//<
////////////////////////////////////////////////////////////////////////////////
WORD _reentrant SysMaskAllInterrupts(void)
{

    #pragma asm
        clr     a
        clr     b   #>$000300,x0

        move    sr,a1               ; get the old value

        move    sr,b1
        or      x0,b
        move    b1,sr               ; mask interrupts

        and     x0,a                ; mask off for the return
        nop
    #pragma endasm

}

////////////////////////////////////////////////////////////////////////////////
//
//>  Name:          SysUnMaskAllInterrupts
//
//   Type:          Function
//
//   Description:   
//
//   Inputs:        WORD            Restore interrupt level bits
//
//   Outputs:       none
//
//   Notes:         none
//<
////////////////////////////////////////////////////////////////////////////////
void _reentrant SysUnMaskAllInterrupts(WORD wLevel)
{

    #pragma asm
        clr     b   #>$FFFCFF,x0

        move    sr,b1               ; get the current sr
        and     x0,b                ; mask off current bits

        move    b1,x0
        or      x0,a                ; mask in the restore bits
        move    a1,sr               ; make it so

        nop
        nop
    #pragma endasm

}

////////////////////////////////////////////////////////////////////////////////
//
//>  Name:          SysGetIrqLevel
//
//   Type:          Function
//
//   Description:   Gets the current system interrupt level
//
//   Inputs:        none
//
//   Outputs:       WORD            IRQ level
//
//   Notes:         Function must move to system for global access
//<
////////////////////////////////////////////////////////////////////////////////
WORD _reentrant SysGetIrqLevel(void)
{

#pragma asm
    move    SR,x0                       ; get the sr register
    move    #>$000300,a                 ; irq mask bits 
    and     x0,a                        ; mask the bits
    rts    
#pragma endasm

}

////////////////////////////////////////////////////////////////////////////////
//
//>  Name:          SysSetIrqLevel
//
//   Type:          Function
//
//   Description:   Sets the system IRQ level
//
//   Inputs:        wIrqLevel       IRQ level
//
//   Outputs:       RETCODE
//
//   Notes:         Function must move to system for global access
//<
////////////////////////////////////////////////////////////////////////////////
RETCODE _reentrant SysSetIrqLevel(WORD wIrqLevel)
{

#pragma asm
    move    SR,x0                       ; get the sr register
    move    #>$FFFCFF,b                 ; irq clear bits 
    and     x0,b                        ; clear the bits
    move    b1,x0
    or      x0,a                        ; get the new level
    move    a1,sr                       ; update the SR with the new level
    nop
#pragma endasm

    return(SUCCESS);
}
