;///////////////////////////////////////////////////////////////////////////////
;  Copyright(C) SigmaTel, Inc. 2000-2001
;
;  File        : stack.asm
;  Description : Stack routines
;///////////////////////////////////////////////////////////////////////////////

    section SYSFUN_StackCheck

;///////////////////////////////////////////////////////////////////////////////
;   Macros
;///////////////////////////////////////////////////////////////////////////////

;///////////////////////////////////////////////////////////////////////////////
;   Includes
;///////////////////////////////////////////////////////////////////////////////

    nolist
    include "sysmacro.asm"
    list

;///////////////////////////////////////////////////////////////////////////////
;   External Definitions
;///////////////////////////////////////////////////////////////////////////////

    ;Functions 
    GLOBAL    FStackCheckOut
    GLOBAL    FStackCheckIn

;///////////////////////////////////////////////////////////////////////////////
;   External References
;///////////////////////////////////////////////////////////////////////////////

    nolist
    include "const.xref"
    list

;///////////////////////////////////////////////////////////////////////////////
;   Equates
;///////////////////////////////////////////////////////////////////////////////

;///////////////////////////////////////////////////////////////////////////////
;   X Memory
;///////////////////////////////////////////////////////////////////////////////
        
;///////////////////////////////////////////////////////////////////////////////
;   Y Memory
;///////////////////////////////////////////////////////////////////////////////
        
;///////////////////////////////////////////////////////////////////////////////
;   P Memory
;///////////////////////////////////////////////////////////////////////////////

    org     p,"StackCheck_P":

;///////////////////////////////////////////////////////////////////////////////
;
;>  Name:           FCheckStackOut
;
;   Type:           Function
;
;   Description:    Verifies that the stack is balanced
;
;   Inputs:         none
;
;   Outputs:        none
;                   
;   Notes:          this should not modify any registers
;<
;///////////////////////////////////////////////////////////////////////////////
  if (@DEF('DEBUG'))
FStackCheckOut
    push a0
    push a1
    push a2
    push x0
    push n7
    move #-6,n7
    move #-6,x0
    move r7,a
    add  x0,a
    move y:(r7+n7),x0
    cmp  x0,a
    ccerror ne
    pop  n7
    pop  x0
    pop  a2
    pop  a1
    pop  a0
    move (r7)-
    move (r7)-
    rts

;///////////////////////////////////////////////////////////////////////////////
;
;>  Name:           FCheckStackIn
;
;   Type:           Function
;
;   Description:    Verifies that the stack is balanced (and writes the current PC on the stack)
;
;   Inputs:         none
;
;   Outputs:        none
;                   
;   Notes:          this should not modify any registers
;<
;///////////////////////////////////////////////////////////////////////////////
FStackCheckIn
    movec SSH,y:(r7)
    move y:(r7)+,SSH
    push r7
    rts

  endif 

    endsec
